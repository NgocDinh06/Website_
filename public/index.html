<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="data:,">
  <meta charset="UTF-8" />
  <title>Smart Streetlight Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-dark text-white text-center p-4">
  <div class="container">
    <h1 class="mb-4">Smart Streetlight Control</h1>
    <button id="logoutBtn" class="btn btn-outline-light float-end">Đăng xuất</button>

    <h3>Trạng thái đèn: <span id="status" class="badge bg-secondary">Đang tải...</span></h3>
    <button id="toggleBtn" class="btn btn-primary mt-3 mb-4">Chuyển trạng thái</button>

    <div class="bg-light rounded p-3 mb-5">
      <canvas id="statusChart" height="100"></canvas>
    </div>

    <h3 class="mb-3">Đặt lịch bật/tắt</h3>
    <form id="scheduleForm" class="row g-3 justify-content-center text-dark bg-light rounded p-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">Bắt đầu</label>
        <input type="time" id="startTime" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Kết thúc</label>
        <input type="time" id="endTime" class="form-control" required />
      </div>
      <div class="col-md-2">
        <label class="form-label">Hành động</label>
        <select id="action" class="form-select" required>
          <option value="on">Bật</option>
          <option value="off">Tắt</option>
        </select>
      </div>
      <div class="col-12 text-start">
        <label class="form-label">Lặp lại vào các ngày:</label><br />
        <div class="form-check form-check-inline text-dark" id="daysContainer"></div>
      </div>
      <div class="col-12 text-center">
        <button type="submit" class="btn btn-success">Lưu lịch</button>
      </div>
    </form>

    <h5>Lịch đã đặt:</h5>
    <ul id="scheduleList" class="list-group text-dark mx-auto" style="max-width: 600px;"></ul>
  </div>
  <div id="adminPanel" class="mt-5 d-none">
    <h3>Quản lý người dùng</h3>
    <form id="createUserForm" class="row g-3 justify-content-center text-dark bg-light rounded p-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">Tên người dùng</label>
        <input type="text" id="newUsername" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Mật khẩu</label>
        <input type="password" id="newPassword" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Vai trò</label>
        <select id="newRole" class="form-select" required >
          <option value="viewer">Viewer</option>
          <option value="controller">Controller</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-12 text-center">
        <button type="submit" class="btn btn-warning">Tạo tài khoản</button>

      </div>
    </form>
    <ul id="userList" class="list-group text-dark mx-auto" style="max-width: 60px;">

    </ul>
  </div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    window.onload = function () {
      const baseURL = 'http://localhost:5000';
      const statusUrl = baseURL + '/api/status';
      const scheduleUrl = baseURL + '/api/schedule';

      function getToken() {
        return localStorage.getItem('accessToken');
      }

      function redirectToLogin() {
        window.location.href = '/login.html';
      }

      function fetchWithAuth(url, options = {}) {
        const token = getToken();
        if (!token) redirectToLogin();

        return fetch(url, {
          ...options,
          headers: {
            ...(options.headers || {}),
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        redirectToLogin();
      });

      if (!getToken()) {
        redirectToLogin();
      }

      const statusEl = document.getElementById('status');
      const toggleBtn = document.getElementById('toggleBtn');
      const chartCtx = document.getElementById('statusChart').getContext('2d');
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const actionInput = document.getElementById('action');
      const scheduleForm = document.getElementById('scheduleForm');
      const scheduleList = document.getElementById('scheduleList');
      const daysContainer = document.getElementById('daysContainer');

      const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      days.forEach((d, i) => {
        daysContainer.innerHTML += `
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day${i}" value="${i}" />
            <label class="form-check-label" for="day${i}">${d}</label>
          </div>
        `;
      });

      let currentStatus = false;
      let chart;

      async function fetchStatus() {
        const res = await fetchWithAuth(statusUrl);
        const data = await res.json();
        currentStatus = data.isOn;
        updateUI();
      }

      function updateUI() {
        statusEl.textContent = currentStatus ? 'BẬT' : 'TẮT';
        statusEl.className = `badge ${currentStatus ? 'bg-success' : 'bg-danger'}`;
        toggleBtn.textContent = currentStatus ? 'Tắt đèn' : 'Bật đèn';
      }

      async function toggleLight() {
        console.log("Bấm chuyển trạng thái");
        const res = await fetchWithAuth(statusUrl, {
          method: 'POST',
          body: JSON.stringify({ isOn: !currentStatus })
        });
        const data = await res.json();
        currentStatus = data.isOn;
        updateUI();
        await loadChart();
      }

      async function loadChart() {
        const res = await fetchWithAuth(statusUrl + '/history?limit=20');
        const data = await res.json();
        const labels = data.map(d => new Date(d.updatedAt).toLocaleTimeString());
        const values = data.map(d => d.isOn ? 1 : 0);

        if (chart) chart.destroy();
        chart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Trạng thái đèn',
              data: values,
              borderColor: 'lime',
              backgroundColor: 'rgba(0,255,0,0.2)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            scales: {
              y: {
                min: 0,
                max: 1,
                ticks: {
                  stepSize: 1,
                  callback: value => value === 1 ? 'Bật' : 'Tắt'
                }
              }
            }
          }
        });
      }

      async function loadSchedules() {
        const res = await fetchWithAuth(scheduleUrl);
        const data = await res.json();
        scheduleList.innerHTML = '';
        data.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const daysStr = item.daysOfWeek.sort().map(d => days[d]).join(', ');
          li.innerHTML = `
            <div>
              <strong>${item.startTime} - ${item.endTime}</strong> (${item.action.toUpperCase()})<br />
              <small>Lặp lại: ${daysStr || 'Không có'}</small>
            </div>
          `;
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-danger';
          delBtn.textContent = 'X';
          delBtn.onclick = async () => {
            await fetchWithAuth(`${scheduleUrl}/${item._id}`, { method: 'DELETE' });
            loadSchedules();
          };
          li.appendChild(delBtn);
          scheduleList.appendChild(li);
        });
      }

      toggleBtn.addEventListener('click', async () => {
        await toggleLight();
      });

      scheduleForm.addEventListener('submit', async e => {
        e.preventDefault();
        const selectedDays = Array.from(document.querySelectorAll('#daysContainer input:checked')).map(d => parseInt(d.value));
        const payload = {
          startTime: startTimeInput.value,
          endTime: endTimeInput.value,
          action: actionInput.value,
          daysOfWeek: selectedDays
        };
        await fetchWithAuth(scheduleUrl, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        scheduleForm.reset();
        loadSchedules();
      });

      // Initial load
      fetchStatus();
      loadChart();
      loadSchedules();
      setInterval(() => {
        fetchStatus();
        loadChart();
      }, 50000);
      async function getUserInfo() {
        const res = await fetchWithAuth(baseURL + '/api/auth/me');
        if (!res.ok) return null;
        return await res.json();
      }
      const adminPanel = document.getElementById('adminPanel');
      const createUSerForm = document.getElementById('createUserForm');
      const userList = document.getElementById('userList');
      
      getUserInfo().then(user =>{
        if(user && user.role ==='admin'){
          adminPanel.classList.remove('d-none');
          loadUser();
        }
      });
      async function loadUser() {
        const res = await fetchWithAuth(`${baseURL}/api/admin/users`);
        if (!res.ok) {
          throw new Error(`Lỗi tải danh sách người dùng: ${res.status}`);
        }
        const users = await res.json();
        userList.innerHTML = '';
        users.forEach(u =>{
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${u.username} (${u.role})`;
          userList.appendChild(li);

        });
      }
      createUSerForm.addEventListener('submit', async e => {
        e.preventDefault();
        const newUser = {
          username: document.getElementById('newUsername').value,
          password: document.getElementById('newPassword').value,
          role: document.getElementById('newRole').value
        };
        await fetchWithAuth(baseURL + '/api/auth/register',{
          method: 'POST',
          body: JSON.stringify(newUser)
        });
        createUSerForm.reset();
        loadUser();
      });
      const token = getToken(); // Lấy token từ localStorage
      const socket = io('http://localhost:5000',{
        auth: {
          token: token
        }
      });

      socket.on('connect', () => {
        console.log(' WebSocket connected');
      });

      socket.on('connect_error', (err) => {
        console.error('WebSocket error:', err.message);
      });

      socket.on('lightStatusUpdated', async function (isOn) {
        console.log('⚡ Đèn thay đổi trạng thái:', isOn ? 'BẬT' : 'TẮT');
        currentStatus = isOn;
        updateUI();
        await loadChart();
      });
    };

  </script>
</body>
</html>
